---
title: "AVE_Notebook"
output:
  html_document:
    df_print: paged
---

```{r message=FALSE, warning=FALSE, include=FALSE, paged.print=FALSE}
library(dplyr)
library(lubridate)
renfeDF <- read.csv(file="~/Documents/GitHub/AVE-Study/renfe.csv")
renfeDF <- na.omit(renfeDF) 
renfeDF <- filter(renfeDF, price != 0)
renfeDF$insert_date <- ymd_hms(renfeDF$insert_date)
renfeDF$start_date <- ymd_hms(renfeDF$start_date)
renfeDF$end_date <- ymd_hms(renfeDF$end_date)

```

Intro

Para visualizar como son los datos a analizar, usamos una entrada aleatoria a los datos recuperando 10 filas aleatorias.

```{r paged.print=TRUE}
renfeDF[sample(nrow(renfeDF), 10),]
```

```{r paged.print=TRUE}
library(psych)
describe(renfeDF$price)
```

En este primer analisis podemos determinar la media, mediana, deviacion estandar, kurtosis y el rango de los datos sin discriminar ninguna variable cualitativa. Podemos ver que la mediana de los precios es 58,15 Euros y que el maximo de todos los datos es 342 Euros.

Vamos a empezar a analizar las variables categoricas de los datos, analizando el precio en funcion del tipo de asiento (Turista, Preferente, Cama, ...)

```{r paged.print=FALSE}
describeBy(renfeDF$price, renfeDF$train_type)
```
```{r paged.print=FALSE}
describeBy(renfeDF$price, renfeDF$train_class)
```
```{r paged.print=FALSE}
describeBy(renfeDF$price, months(as.Date(renfeDF$start_date)))
```

A continuacion vamos a utilizar la libreria fitdistrplus para ver si los datos se pueden asemejar a una distribucion de datos conocida. Para eso utilizamos el comando descdist que nos presenta un grafico de Cullen y Frey.

```{r message=FALSE, warning=FALSE}
library(fitdistrplus)
descdist(renfeDF$price)
```
Vemos que los datos se podrian asemejar a una lognormal o incluso a una distribucion gamma. Vamos a decidir numericamente si los datos se pueden asemejar a una distribucion normal usando el test de Shapiro-Wilkinson.


Aun asi vamos a representar los datos en un histograma para descartar que se trate de una distibucion normal. Para ello usamos la libreria rcompanion.
 
```{r message=FALSE, warning=FALSE}
library(rcompanion)
plotNormalHistogram(renfeDF$price)
```

Ahora hacemos el test Shapiro-Wilkinson para tener confirmacion numerica de que no se trata de una normal.


```{r warning=FALSE}
library(fitdistrplus)
shapiro.test(renfeDF$price[1:5000])
```
Podemos asumir que los datos no se asemejan a una normal ya que el p-value obtenido del test de Shapiro-Wilkinson es menor que 0.05.

Ahora vamos a modificar los datos usando una transformacion logaritmica para ver si conseguimos que se asemeje a una distribucion normal.


```{r echo=FALSE, message=FALSE, warning=FALSE}
library(fitdistrplus)
descdist(log(renfeDF$price))
```

Al hacer la transformacion de los datos podemos ver que los datos ahora se asemejan a una normal tras realizar una transformacion logaritmica sobre el precio. Ahora mostramos un histograma sobre los datos transformados para ver como se asemeja a una curva normal.

```{r message=FALSE, warning=FALSE}
plotNormalHistogram(log(renfeDF$price))
```

Podemos ver que excepto un par de valores que sobresalen por la curva normal, el conjunto de datos se comporta como una curva normal.

```{r message=FALSE, warning=FALSE}
library(car)
qqPlot(renfeDF[sample(nrow(renfeDF), 100000),]$price)
```

Haciendo el Q-Q plot vemos que hay muchos valores que no se asemejan a la recta normal, lo cual concuerda con las previas conclusiones de que los datos de precio, no se asemejan a una distribucion normal. En cambio si repetimos este mismo grafico con una transformacion logaritmica obtenemos unos resultados que se pueden aproximar a una normal. Para ver con mas precision los datos extraemos 100 filas de los datos de manera aleatoria por lo que hacemos 3 veces el mismo grafico para asegurar que los datos de verdad se asemejan a una normal.


```{r message=FALSE, warning=FALSE, paged.print=TRUE}
qqPlot(log(renfeDF[sample(nrow(renfeDF), 100),]$price))
qqPlot(log(renfeDF[sample(nrow(renfeDF), 100),]$price))
qqPlot(log(renfeDF[sample(nrow(renfeDF), 100),]$price))
```
